<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  <script src="order-script.js" defer></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .badge {
      display: inline-block;
      background: #f5576c;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 8px;
    }

    form {
      margin-bottom: 25px;
    }

    .menu-section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #f5576c;
    }

    .menu-section h3 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }

    .form-group {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group label {
      flex: 1;
      font-size: 14px;
      color: #444;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
    }

    .form-group input[type="number"] {
      width: 70px;
      padding: 8px 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      transition: all 0.3s ease;
    }

    .form-group input[type="number"]:focus {
      outline: none;
      border-color: #f5576c;
      box-shadow: 0 0 8px rgba(245, 87, 108, 0.2);
    }

    .form-group input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input[type="text"]:focus {
      outline: none;
      border-color: #f5576c;
      box-shadow: 0 0 8px rgba(245, 87, 108, 0.2);
    }

    .customer-section {
      margin: 20px 0;
      padding: 15px;
      background: #fff3f5;
      border-radius: 8px;
      border-left: 4px solid #f5576c;
    }

    .customer-section label {
      display: block;
      font-size: 14px;
      color: #444;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .total-section {
      margin: 20px 0;
      padding: 15px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 8px;
      text-align: center;
    }

    #total {
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    #status {
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      min-height: 24px;
      font-size: 14px;
      font-weight: 500;
      display: none;
      max-height: 800px;
      overflow-y: auto;
    }

    #status.show {
      display: block;
    }

    #status.success {
      background: #f5f9ff;
      color: #2a5298;
      border-left: 4px solid #2a5298;
    }

    #status.error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }

    #status.loading {
      background: #e3f2fd;
      color: #1565c0;
      border-left: 4px solid #2196f3;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .footer a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #f5576c;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s ease;
      padding: 8px 16px;
      border-radius: 6px;
    }

    .footer a:hover {
      background: #fff0f3;
      color: #f093fb;
    }

    .footer a::before {
      content: "‚Üê";
      font-size: 18px;
    }

    @media (max-width: 480px) {
      .container {
        padding: 25px;
      }

      .header h1 {
        font-size: 24px;
      }

      #total {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üõí ‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
      <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</p>
      <span class="badge">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
    </div>

    <form id="orderForm">
      <div class="menu-section">
        <h3>üìã ‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <div id="orderMenu"></div>
      </div>

      <div class="customer-section">
        <label for="customerName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á *</label>
        <input type="text" id="customerName" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠" required>
      </div>

      <div class="total-section">
        <p id="total">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏ö‡∏≤‡∏ó</p>
      </div>

      <button type="submit">‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
    </form>

    <div id="status"></div>

    <div class="footer">
      <a href="seller.html">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</a>
      <a href="report.html" style="margin-left: 10px;">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a>
    </div>
  </div>

  <script>
  (function(){
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxI_onG1cy47WNP4j3_HrmSGyBwL9XGFwZBTZtZtnQTaI6y0N6sPL_9hP_XrCd76BI/exec';
    const form = document.getElementById('orderForm');
    if (!form) return;
    form.addEventListener('submit', async function(ev){
      ev.preventDefault();
      const statusEl = document.getElementById('status');
      statusEl.className = 'loading show';
      statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...';

      // build params
      const fd = new FormData(form);
      fd.append('timestamp', new Date().toISOString());
      const params = new URLSearchParams();
      for (const [k,v] of fd.entries()) params.append(k, v);

      // try fetch with short timeout
      try {
        const controller = new AbortController();
        const timeout = setTimeout(()=>controller.abort(), 8000);
        const resp = await fetch(WEB_APP_URL, { method: 'POST', body: params, signal: controller.signal });
        clearTimeout(timeout);

        if (!resp.ok) throw new Error('Network response not OK: ' + resp.status);
        const data = await resp.json().catch(()=>null);
        if (data && data.success) {
          statusEl.className = 'success show';
          statusEl.textContent = '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          form.reset();
          return;
        }
        // server returned non-success or invalid JSON -> fallback to form submit
        statusEl.className = 'error show';
        statusEl.textContent = '‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•...';
      } catch (err) {
        // fetch failed (network/CORS/timeout) -> fallback
        statusEl.className = 'error show';
        statusEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô AJAX (' + (err.name || err.message) + '), ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏ó‡∏ô...';
      }

      // Fallback: submit a real form to WEB_APP_URL in a new tab (bypass AJAX/CORS issues)
      try {
        const fallbackForm = document.createElement('form');
        fallbackForm.method = 'POST';
        fallbackForm.action = WEB_APP_URL;
        fallbackForm.target = '_blank';
        // copy params into hidden inputs
        for (const [k,v] of params.entries()) {
          const inp = document.createElement('input');
          inp.type = 'hidden';
          inp.name = k;
          inp.value = v;
          fallbackForm.appendChild(inp);
        }
        document.body.appendChild(fallbackForm);
        fallbackForm.submit();
        setTimeout(()=>fallbackForm.remove(), 2000);
      } catch (e) {
        statusEl.className = 'error show';
        statusEl.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ Postman: ' + (e.message || e);
      }
    });
  })();

  function generateOrderId() {
    const timestamp = Date.now().toString(36).toUpperCase(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á timestamp ‡πÅ‡∏ö‡∏ö base36
    const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°
    return `ORD-${timestamp}-${randomPart}`;
  }

  function placeOrder() {
    const orderId = generateOrderId(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á orderId
    const customerName = document.getElementById('customerName').value;
    const items = collectOrderItems(); // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    const totalAmount = calculateTotal(items); // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°

    if (!customerName || items.length === 0) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      return;
    }

    const orderData = {
      orderId,
      customerName,
      items,
      totalAmount,
      date: new Date().toISOString()
    };

    sendOrderToServer(orderData).then(response => {
      if (response.success) {
        alert(`‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${orderId}`);
        resetOrderForm(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      } else {
        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${response.message}`);
      }
    });
  }

  async function sendOrderToServer(orderData) {
    try {
      const response = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData)
      });
      return await response.json();
    } catch (error) {
      return { success: false, message: error.message };
    }
  }
  </script>
</body>
</html>
