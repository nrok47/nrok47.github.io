name: Sync Data to JSON Files

on:
  # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å ‡πÜ 5 ‡∏ô‡∏≤‡∏ó‡∏µ
  schedule:
    - cron: '*/5 * * * *'
  
  # ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ push ‡πÑ‡∏õ‡∏¢‡∏±‡∏á main branch
  push:
    branches:
      - main
    paths:
      - 'index-script.js'
      - 'order-script.js'
  
  # ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ô manual ‡πÑ‡∏î‡πâ
  workflow_dispatch:

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Clone repository
      - name: Checkout repository
        uses: actions/checkout@v3
      
      # 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      # 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï JSON files
      - name: Update JSON files
        run: |
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á script Node.js
          cat > update-data.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå stock-data.json ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          function readJSONFile(filename) {
            try {
              if (fs.existsSync(filename)) {
                const data = fs.readFileSync(filename, 'utf8');
                return JSON.parse(data);
              }
            } catch (err) {
              console.error(`Error reading ${filename}:`, err);
            }
            return null;
          }
          
          // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON
          function writeJSONFile(filename, data) {
            try {
              fs.writeFileSync(filename, JSON.stringify(data, null, 2), 'utf8');
              console.log(`‚úì Updated ${filename}`);
              return true;
            } catch (err) {
              console.error(`Error writing ${filename}:`, err);
              return false;
            }
          }
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ stock-data.json ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ
          const stockPath = './stock-data.json';
          const ordersPath = './orders-log.json';
          
          const currentStock = readJSONFile(stockPath);
          const currentOrders = readJSONFile(ordersPath) || [];
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          if (currentStock && typeof currentStock === 'object') {
            console.log('‚úì stock-data.json is valid');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            Object.keys(currentStock).forEach(item => {
              const qty = currentStock[item];
              if (qty < 0) {
                console.warn(`‚ö†Ô∏è Warning: ${item} has negative quantity (${qty})`);
                currentStock[item] = 0; // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
              }
            });
            
            writeJSONFile(stockPath, currentStock);
          }
          
          if (Array.isArray(currentOrders)) {
            console.log('‚úì orders-log.json is valid');
            writeJSONFile(ordersPath, currentOrders);
          } else {
            console.log('‚úì Creating new orders-log.json');
            writeJSONFile(ordersPath, []);
          }
          
          console.log('Data sync completed!');
          EOF
          
          node update-data.js
      
      # 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      # 5. Commit ‡πÅ‡∏•‡∏∞ Push ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          git add stock-data.json orders-log.json
          git commit -m "ü§ñ Auto-update JSON data files"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 6. ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
      - name: No changes detected
        if: steps.check-changes.outputs.has_changes == 'false'
        run: echo "‚úì No changes to commit"
