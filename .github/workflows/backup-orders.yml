name: Process Orders Backup

on:
  # à¸—à¸³à¸‡à¸²à¸™à¸—à¸¸à¸à¸§à¸±à¸™à¹€à¸—à¸µà¹ˆà¸¢à¸‡ 12:00 UTC
  schedule:
    - cron: '0 12 * * *'
  
  # à¸£à¸±à¸™ manual
  workflow_dispatch:

jobs:
  backup-orders:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Backup and analyze orders
        run: |
          cat > backup-orders.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          // à¸­à¹ˆà¸²à¸™ orders log
          function readOrders() {
            try {
              const data = fs.readFileSync('./orders-log.json', 'utf8');
              return JSON.parse(data);
            } catch (err) {
              console.error('Error reading orders:', err);
              return [];
            }
          }
          
          const orders = readOrders();
          
          // à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸£à¸¸à¸› orders à¸£à¸²à¸¢à¸§à¸±à¸™
          const today = new Date().toISOString().split('T')[0];
          const backupDir = './backups';
          
          if (!fs.existsSync(backupDir)) {
            fs.mkdirSync(backupDir, { recursive: true });
          }
          
          // à¸šà¸±à¸™à¸—à¸¶à¸ backup
          const backupFile = path.join(backupDir, `orders-backup-${today}.json`);
          fs.writeFileSync(backupFile, JSON.stringify(orders, null, 2));
          
          // à¸ªà¸£à¸¸à¸›à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
          let totalRevenue = 0;
          let totalOrders = orders.length;
          const itemsSold = {};
          
          orders.forEach(order => {
            totalRevenue += order.totalAmount || 0;
            Object.keys(order.orders || {}).forEach(item => {
              itemsSold[item] = (itemsSold[item] || 0) + order.orders[item];
            });
          });
          
          console.log(`\nðŸ“Š Orders Report for ${today}`);
          console.log(`Total Orders: ${totalOrders}`);
          console.log(`Total Revenue: ${totalRevenue} à¸šà¸²à¸—`);
          console.log(`\nItems Sold:`);
          Object.entries(itemsSold).forEach(([item, qty]) => {
            console.log(`  - ${item}: ${qty} units`);
          });
          console.log(`\nâœ“ Backup saved to ${backupFile}`);
          EOF
          
          node backup-orders.js
      
      - name: Commit backup
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add backups/
            git commit -m "ðŸ“¦ Daily orders backup"
            git push origin main
          else
            echo "âœ“ No new backups to commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
