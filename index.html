<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>
  <link rel="stylesheet" href="css/site.css">
</head>
<body>
  <?!= include('menu') ?>
  <div class="container">
    <h1>üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>
    <table id="data-table">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer Name</th>
          <th>Total Amount</th>
          <th>Paid</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be dynamically inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    // Use google.script.run to call server-side functions in Apps Script
    function fetchData() {
      try {
        google.script.run.withSuccessHandler(populateTable).apiGetOrders();
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    function populateTable(data) {
      const tableBody = document.querySelector('#data-table tbody');
      tableBody.innerHTML = '';
      data.forEach(order => {
        const row = document.createElement('tr');
        const payButton = !order.paid ? `<button onclick="payOrder('${order.orderId}', ${order.totalAmount})">Pay</button>` : '';
        row.innerHTML = `
          <td>${order.orderId}</td>
          <td>${order.customerName}</td>
          <td>${order.totalAmount}</td>
          <td>${order.paid ? 'Yes' : payButton}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    async function payOrder(orderId, totalAmount) {
      const paymentMethods = ['QR code', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå', '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'];

      // Create a modal for payment method selection
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '1000';

      const modalContent = document.createElement('div');
      modalContent.style.backgroundColor = '#fff';
      modalContent.style.padding = '20px';
      modalContent.style.borderRadius = '8px';
      modalContent.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
      modalContent.innerHTML = '<h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>';

      const list = document.createElement('ul');
      list.style.listStyleType = 'none';
      list.style.padding = '0';

      paymentMethods.forEach((method, index) => {
        const listItem = document.createElement('li');
        listItem.style.margin = '10px 0';

        const button = document.createElement('button');
        button.textContent = method;
        button.style.padding = '10px 20px';
        button.style.border = 'none';
        button.style.borderRadius = '4px';
        button.style.backgroundColor = '#007BFF';
        button.style.color = '#fff';
        button.style.cursor = 'pointer';

        button.addEventListener('click', async () => {
          document.body.removeChild(modal);
            try {
              // call server function via google.script.run
              google.script.run.withSuccessHandler(function(result) {
                if (result && result.success) {
                  alert('Payment successful!');
                  fetchData();
                } else {
                  alert('Payment failed: ' + (result && result.message ? result.message : 'Unknown error'));
                }
              }).apiUpdatePayment({ orderId: orderId, paidAmount: totalAmount, paymentMethod: method });
            } catch (error) {
              alert('Payment failed: ' + error.message);
              console.error('Error processing payment:', error);
            }
        });

        listItem.appendChild(button);
        list.appendChild(listItem);
      });

      modalContent.appendChild(list);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    }

    fetchData();
  </script>
</body>
</html>
