<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ - ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 3px solid #2a5298;
      padding-bottom: 20px;
    }

    .header h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .date-picker {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }

    .date-picker input {
      padding: 10px 15px;
      border: 2px solid #2a5298;
      border-radius: 6px;
      font-size: 14px;
    }

    .date-picker button {
      padding: 10px 20px;
      background: #2a5298;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .date-picker button:hover {
      background: #1e3c72;
      transform: translateY(-2px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .stat-card h3 {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: bold;
    }

    .orders-section {
      margin: 30px 0;
    }

    .orders-section h2 {
      font-size: 20px;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .orders-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .orders-table thead {
      background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
      color: white;
    }

    .orders-table th {
      padding: 15px;
      text-align: left;
      font-weight: bold;
      font-size: 14px;
    }

    .orders-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 14px;
    }

    .orders-table tbody tr:hover {
      background: #f9f9f9;
    }

    .orders-table tbody tr:last-child td {
      border-bottom: none;
    }

    .customer-name {
      font-weight: bold;
      color: #333;
    }

    .order-items {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }

    .amount {
      font-weight: bold;
      color: #2a5298;
      font-size: 15px;
    }

    .time {
      color: #999;
      font-size: 13px;
    }

    .items-breakdown {
      margin: 30px 0;
    }

    .items-breakdown h2 {
      font-size: 20px;
      color: #333;
      margin-bottom: 15px;
    }

    .items-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .item-card {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #2a5298;
    }

    .item-card .name {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }

    .item-card .qty {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .item-card .qty-value {
      font-size: 24px;
      font-weight: bold;
      color: #2a5298;
    }

    .item-card .qty-label {
      font-size: 12px;
      color: #666;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    .no-data-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .footer a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #2a5298;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s ease;
      padding: 8px 16px;
      border-radius: 6px;
    }

    .footer a:hover {
      background: #f0f0f0;
      color: #1e3c72;
    }

    .export-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background: #2a5298;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .export-btn:hover {
      background: #1e3c72;
      transform: translateY(-2px);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .summary-table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
    }

    .summary-table th,
    .summary-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-table th {
      background: #f0f0f0;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .orders-table {
        font-size: 12px;
      }

      .orders-table th,
      .orders-table td {
        padding: 8px;
      }

      .date-picker {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h1>
      <p>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</p>
    </div>

    <div class="date-picker">
      <label for="reportDate">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
      <input type="date" id="reportDate">
      <button onclick="generateReport()">üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      <button onclick="exportToCSV()" class="export-btn">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid" id="statsGrid" style="display: none;">
      <div class="stat-card">
        <h3>üõçÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
        <div class="value" id="totalOrders">0</div>
      </div>
      <div class="stat-card">
        <h3>üí∞ ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
        <div class="value" id="totalRevenue">0</div>
      </div>
      <div class="stat-card">
        <h3>üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
        <div class="value" id="uniqueCustomers">0</div>
      </div>
      <div class="stat-card">
        <h3>üì¶ ‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div class="value" id="totalItems">0</div>
      </div>
    </div>

    <!-- Orders Table -->
    <div class="orders-section" id="ordersSection" style="display: none;">
      <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
      <table class="orders-table" id="ordersTable">
        <thead>
          <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>Order ID</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
            </tr>
        </thead>
        <tbody id="ordersBody">
        </tbody>
      </table>
    </div>

    <!-- Items Breakdown -->
    <div class="items-breakdown" id="itemsBreakdown" style="display: none;">
      <h2>üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h2>
      <div class="items-list" id="itemsList">
      </div>

      <h3 style="margin-top: 30px; margin-bottom: 15px;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
      <table class="summary-table" id="summaryTable">
        <thead>
          <tr>
            <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
          </tr>
        </thead>
        <tbody id="summaryBody">
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
      <div class="empty-state-icon">üì≠</div>
      <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
      <p style="font-size: 12px; margin-top: 8px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"</p>
    </div>

    <div class="footer">
      <a href="seller.html">‚Üê ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</a>
      <a href="order.html">‚Üí ‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
    </div>
  </div>

  

  <script>
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxI_onG1cy47WNP4j3_HrmSGyBwL9XGFwZBTZtZtnQTaI6y0N6sPL_9hP_XrCd76BI/exec';

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('reportDate').value = today;
      generateReport();
    });

    async function generateReport() {
      const selectedDate = document.getElementById('reportDate').value;
      if (!selectedDate) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
        return;
      }

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å Google Sheet ‡πÄ‡∏™‡∏°‡∏≠
      const ordersLog = await fetchOrdersFromSheet();

      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏Å‡πá‡∏ö index ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πà‡∏≠)
      const filteredOrders = ordersLog
        .map((order, idx) => Object.assign({}, order, { _idx: idx }))
        .filter(order => {
          const orderDate = new Date(order.date).toISOString().split('T')[0];
          return orderDate === selectedDate;
        });

      if (filteredOrders.length === 0) {
        document.getElementById('statsGrid').style.display = 'none';
        document.getElementById('ordersSection').style.display = 'none';
        document.getElementById('itemsBreakdown').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }

      // ‡πÅ‡∏™‡∏î‡∏á sections
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('statsGrid').style.display = 'grid';
      document.getElementById('ordersSection').style.display = 'block';
      document.getElementById('itemsBreakdown').style.display = 'block';

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
      const stats = calculateStats(filteredOrders);
      displayStats(stats);
      displayOrders(filteredOrders);
      displayItemsBreakdown(stats);
    }

    async function fetchOrdersFromSheet() {
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏à‡∏≤‡∏Å Google Apps Script Web App (‡∏Ñ‡∏ß‡∏£‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á objects)
  try {
    const res = await fetch(WEB_APP_URL);
    if (!res.ok) throw new Error('Network response was not ok');
    const rows = await res.json();

    if (!Array.isArray(rows)) return [];

    // helper: ‡πÅ‡∏õ‡∏•‡∏á field orders ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô { itemName: { qty, price, total } }
    const parseOrdersField = (raw) => {
      if (!raw) return {};
      if (typeof raw === 'object') {
        // ‡∏ñ‡πâ‡∏≤ already parsed object, try to normalize
        const obj = {};
        Object.entries(raw).forEach(([k, v]) => {
          const qty = Number(v.qty || v.quantity || v.q) || 0;
          const price = Number(v.price) || Number(v.unitPrice) || 0;
          obj[k] = { qty, price, total: Number(v.total) || qty * price };
        });
        return obj;
      }
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse JSON ‡∏Å‡πà‡∏≠‡∏ô
      try {
        const parsed = JSON.parse(raw);
        if (typeof parsed === 'object') return parseOrdersField(parsed);
      } catch (e) { /* not JSON */ }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö simple ‡πÄ‡∏ä‡πà‡∏ô "Apple:2:50;Banana:3:10"
      const items = {};
      const parts = raw.split(/[\n;|]/).map(p => p.trim()).filter(Boolean);
      parts.forEach(token => {
        // ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏•‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö name:qty:price
        const a = token.split(':').map(s => s.trim());
        if (a.length >= 3) {
          const name = a[0];
          const qty = Number(a[1]) || 0;
          const price = Number(a[2]) || 0;
          items[name] = { qty, price, total: qty * price };
          return;
        }
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "name x qty @price" ‡πÄ‡∏ä‡πà‡∏ô "Apple x2 @50"
        const m = token.match(/^(.+?)\s*x\s*(\d+)\s*@\s*(\d+(\.\d+)?)$/i);
        if (m) {
          const name = m[1].trim();
          const qty = Number(m[2]) || 0;
          const price = Number(m[3]) || 0;
          items[name] = { qty, price, total: qty * price };
          return;
        }
        // fallback: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ qty/price ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        items[token] = { qty: 1, price: 0, total: 0 };
      });
      return items;
    };

    // ‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ row ‡πÄ‡∏õ‡πá‡∏ô object ‡∏ó‡∏µ‡πà‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á
    const orders = rows.map(r => {
      const dateField = r.date || r.timestamp || r.createdAt || r.datetime || r.time || '';
      const date = dateField ? new Date(dateField).toISOString() : new Date().toISOString();
      const customerName = r.customerName || r.name || r.customer || r.buyer || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const ordersObj = parseOrdersField(r.orders || r.items || r.order_details || r.order);
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì totalAmount ‡∏à‡∏≤‡∏Å ordersObj ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå totalAmount
      let totalAmount = Number(r.totalAmount || r.total || r.amount) || 0;
      if (!totalAmount) {
        totalAmount = Object.values(ordersObj).reduce((s, d) => s + (Number(d.total) || (Number(d.qty || 0) * Number(d.price || 0))), 0);
      }
      const paidAmount = Number(r.paidAmount || r.paid || 0) || 0;
      const payments = (() => {
        try {
          const p = r.payments || r.payment || r.payment_history;
          if (!p) return [];
          if (typeof p === 'string') return JSON.parse(p);
          if (Array.isArray(p)) return p;
          return [p];
        } catch (e) {
          return [];
        }
      })();
      const paid = Boolean(r.paid) || paidAmount >= totalAmount;
      // include orderId and rowNumber if provided by backend
      const orderId = r.orderId || r.orderID || r.id || null;
      const rowNumber = r.rowNumber || r.row || null;

      return {
        date,
        customerName,
        orders: ordersObj,
        totalAmount,
        paidAmount,
        payments,
        paid,
        orderId,
        rowNumber
      };
    });

    return orders;
  } catch (err) {
    alert('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    return [];
  }
}

    function calculateStats(orders) {
      let totalOrders = orders.length;
      let totalRevenue = 0;
      let uniqueCustomers = new Set();
      let totalItems = 0;
      let itemsData = {};
      let itemsPrice = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• order)

      orders.forEach(order => {
        totalRevenue += order.totalAmount || 0;
        uniqueCustomers.add(order.customerName);

        // order.orders now expected as { item: { qty, price, total } }
        Object.entries(order.orders || {}).forEach(([item, detail]) => {
          const qty = (detail && detail.qty) ? Number(detail.qty) : 0;
          totalItems += qty;
          if (!itemsData[item]) {
            itemsData[item] = 0;
          }
          itemsData[item] += qty;
          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ price ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ order ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö (‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
          const price = (detail && Number.isFinite(Number(detail.price))) ? Number(detail.price) : (itemsPrice[item] || 0);
          if (price) itemsPrice[item] = price;
        });
      });

      return {
        totalOrders,
        totalRevenue,
        uniqueCustomers: uniqueCustomers.size,
        totalItems,
        itemsData,
        itemsPrice
      };
    }

    function displayStats(stats) {
      document.getElementById('totalOrders').textContent = stats.totalOrders;
      document.getElementById('totalRevenue').textContent = stats.totalRevenue.toLocaleString('th-TH') + ' ‡∏ö‡∏≤‡∏ó';
      document.getElementById('uniqueCustomers').textContent = stats.uniqueCustomers;
      document.getElementById('totalItems').textContent = stats.totalItems + ' ‡∏ä‡∏¥‡πâ‡∏ô';
    }

    function displayOrders(orders) {
      const tbody = document.getElementById('ordersBody');
      tbody.innerHTML = '';

      orders.forEach((order, idx) => {
        const date = new Date(order.date);
        const time = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

        // orders may be { itemId_or_name: { name, qty, price, total } }
        const items = Object.entries(order.orders || {}).map(([key, detail])=>{
          const name = (detail && detail.name) ? detail.name : key;
          const qty = (detail && detail.qty) ? detail.qty : 0;
          const price = (detail && detail.price) ? detail.price : 0;
          const total = (detail && detail.total) ? detail.total : (qty * price);
          return `${name}: ${qty} ‡∏ä‡∏¥‡πâ‡∏ô √ó ‡∏ø${price} = ‡∏ø${total}`;
        }).join('<br>');

        const totalQty = Object.values(order.orders || {})
          .reduce((sum, detail) => sum + (detail.qty || 0), 0);

        let paymentCell = '';
        const paidAmount = order.paidAmount || 0;
        const isPaid = order.paid || (paidAmount >= (order.totalAmount || 0));
        if (isPaid) {
          const paidText = `‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‡∏ø${paidAmount}`;
          paymentCell = `<td style="color:green; font-weight:bold;">${paidText}</td>`;
        } else {
          // prepare a button with data attributes so collectPayment can read values reliably
          const orderIdEsc = order.orderId ? String(order.orderId).replace(/'/g, "\\'") : '';
          const rowNumberVal = order.rowNumber ? order.rowNumber : '';
          const totalAmtArg = order.totalAmount || 0;
          const paidAmtArg = order.paidAmount || 0;
          paymentCell = `<td><button data-orderid='${orderIdEsc}' data-row='${rowNumberVal}' data-total='${totalAmtArg}' data-paid='${paidAmtArg}' onclick="collectPayment(this)">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button></td>`;
        }

        const row = `
          <tr>
            <td class="time">${time}</td>
            <td class="order-id">${order.orderId ? order.orderId : 'row#' + (order.rowNumber || '')}</td>
            <td class="customer-name">${order.customerName}</td>
            <td class="order-items">${items}</td>
            <td>${totalQty} ‡∏ä‡∏¥‡πâ‡∏ô</td>
            <td class="amount">${order.totalAmount} ‡∏ö‡∏≤‡∏ó</td>
            ${paymentCell}
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    
      function collectPayment(btn) {
        // read data from button attributes
        const orderId = btn.getAttribute('data-orderid') || null;
        const rowNumber = btn.getAttribute('data-row') ? Number(btn.getAttribute('data-row')) : null;
        const totalAmount = Number(btn.getAttribute('data-total') || 0);
        const paidAmount = Number(btn.getAttribute('data-paid') || 0);

        if (!orderId && !rowNumber) {
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• orderId ‡∏´‡∏£‡∏∑‡∏≠ rowNumber');
          return;
        }
        // calculate remaining amount (we assume full payment each time)
        const remaining = (Number(totalAmount) || 0) - (Number(paidAmount) || 0);
        if (remaining <= 0) {
          alert('‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡πâ‡∏ß');
          return;
        }

        // show payment method choices (QR code, PromptPay, Cash)
        showPaymentChoice(function(method) {
          if (!method) return;
          const params = {
            orderId: orderId,
            rowNumber: rowNumber,
            paidAmount: Number(remaining),
            paymentMethod: method
          };

          updatePaymentStatus(params).then(result => {
            if (result.success) {
              alert('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
              generateReport();
            } else {
              alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (result.message || 'unknown'));
            }
          });
        });
      }

      // UI helper: show an overlay with bullet choices for payment method
      function showPaymentChoice(onChoose) {
        // create overlay
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.left = 0;
        overlay.style.top = 0;
        overlay.style.right = 0;
        overlay.style.bottom = 0;
        overlay.style.background = 'rgba(0,0,0,0.4)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = 9999;

        const box = document.createElement('div');
        box.style.background = '#fff';
        box.style.borderRadius = '8px';
        box.style.padding = '20px';
        box.style.minWidth = '280px';
        box.style.boxShadow = '0 6px 24px rgba(0,0,0,0.2)';

        const title = document.createElement('div');
        title.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)';
        title.style.marginBottom = '12px';
        title.style.fontWeight = '700';
        box.appendChild(title);

        const list = document.createElement('ul');
        list.style.listStyle = 'disc';
        list.style.paddingLeft = '20px';
        list.style.marginBottom = '12px';

        const options = [
          { key: 'qr', label: 'QR code' },
          { key: 'promptpay', label: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå' },
          { key: 'cash', label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' }
        ];

        options.forEach(opt => {
          const li = document.createElement('li');
          li.style.margin = '8px 0';
          const btn = document.createElement('button');
          btn.textContent = opt.label;
          btn.style.padding = '8px 12px';
          btn.style.marginLeft = '8px';
          btn.style.border = '1px solid #ccc';
          btn.style.borderRadius = '6px';
          btn.style.cursor = 'pointer';
          btn.onclick = () => {
            document.body.removeChild(overlay);
            onChoose(opt.label);
          };
          li.appendChild(document.createTextNode(''));
          li.appendChild(btn);
          list.appendChild(li);
        });

        box.appendChild(list);

        const cancel = document.createElement('button');
        cancel.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
        cancel.style.marginTop = '8px';
        cancel.onclick = () => { document.body.removeChild(overlay); onChoose(null); };
        box.appendChild(cancel);

        overlay.appendChild(box);
        document.body.appendChild(overlay);
      }

    async function updatePaymentStatus(params) {
      try {
        // Use form-urlencoded to avoid CORS preflight. Do NOT set custom headers.
        const body = new URLSearchParams();
        body.append('type', 'setPaid');
        if (params.orderId) body.append('orderId', params.orderId);
        if (params.rowNumber) body.append('rowNumber', String(params.rowNumber));
        body.append('paidAmount', String(Number(params.paidAmount)));
        body.append('paymentMethod', params.paymentMethod);

        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: body
        });
        if (!response.ok) throw new Error('Network error');
        const result = await response.json().catch(() => ({ success: false, message: 'Invalid JSON response' }));
        return result;
      } catch (err) {
        return { success: false, message: err.message };
      }
    }

    function displayItemsBreakdown(stats) {
      const itemsList = document.getElementById('itemsList');
      const summaryBody = document.getElementById('summaryBody');

      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
      itemsList.innerHTML = '';
      summaryBody.innerHTML = '';

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      Object.entries(stats.itemsData).forEach(([item, qty]) => {
        const card = `
          <div class="item-card">
            <div class="name">${item}</div>
            <div class="qty">
              <span class="qty-label">‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ:</span>
              <span class="qty-value">${qty} ‡∏ä‡∏¥‡πâ‡∏ô</span>
            </div>
          </div>
        `;
        itemsList.innerHTML += card;
      });

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á summary ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å stats.itemsPrice (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ fallback 20)
      Object.entries(stats.itemsData).forEach(([item, qty]) => {
        const price = (stats.itemsPrice && Number.isFinite(Number(stats.itemsPrice[item]))) ? Number(stats.itemsPrice[item]) : 20;
        const total = price * qty;
        const row = `
          <tr>
            <td>${item}</td>
            <td>${qty} ‡∏ä‡∏¥‡πâ‡∏ô</td>
            <td class="amount">${total.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó</td>
          </tr>
        `;
        summaryBody.innerHTML += row;
      });
    }

    function extractPrice(itemName) {
      // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ localStorage ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚Äî ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ fetchOrdersFromSheet ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏°‡∏≤
      return 20;
    }

    async function exportToCSV() {
      const selectedDate = document.getElementById('reportDate').value;
      const ordersLog = await fetchOrdersFromSheet();

      const filteredOrders = ordersLog.filter(order => {
        const orderDate = new Date(order.date).toISOString().split('T')[0];
        return orderDate === selectedDate;
      });

      if (filteredOrders.length === 0) {
        alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
        return;
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á CSV
      let csv = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤,‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤,‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°,‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏ß‡∏°,‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞\n';

      filteredOrders.forEach(order => {
        const date = new Date(order.date).toLocaleDateString('th-TH');
        const time = new Date(order.date).toLocaleTimeString('th-TH', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });

        // order.orders is { item: {qty, price, total} }
        // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ (sum) ‡πÅ‡∏•‡∏∞ channels
        const paidAmount = order.paidAmount || 0;
        const methods = (order.payments || []).map(p => p.method).join(';');
        Object.entries(order.orders || {}).forEach(([item, detail]) => {
          const qty = detail.qty || 0;
          csv += `"${date}","${time}","${order.customerName}","${item}",${qty},"${order.totalAmount}","${paidAmount}","${methods}","${order.paid ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}"\n`;
        });
      });

      // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `report-${selectedDate}.csv`);
      link.click();
    }
  </script>
</body>
</html>
